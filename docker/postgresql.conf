# =============================================================================
#  QUICKBOM POSTGRESQL CONFIGURATION
# =============================================================================
# Optimized PostgreSQL configuration for QuickBom application
# Based on PostgreSQL 15 with performance tuning for containerized environment
# =============================================================================

# -----------------------------------------------------------------------------
#  CONNECTIONS AND AUTHENTICATION
# -----------------------------------------------------------------------------
# Maximum number of concurrent connections
max_connections = 100

# Authentication timeout (in seconds)
authentication_timeout = 60s

# Password encryption method
password_encryption = scram-sha-256

# -----------------------------------------------------------------------------
#  MEMORY SETTINGS
# -----------------------------------------------------------------------------
# Shared memory buffers (25% of available RAM, adjust based on container limits)
shared_buffers = 256MB

# Work memory per connection (for complex queries)
work_mem = 4MB

# Maintenance work memory (for VACUUM, CREATE INDEX, etc.)
maintenance_work_mem = 64MB

# Effective cache size (70% of available RAM)
effective_cache_size = 1GB

# -----------------------------------------------------------------------------
#  QUERY PLANNING
# -----------------------------------------------------------------------------
# Random page cost (for SSD storage in containers)
random_page_cost = 1.1

# CPU tuple cost
cpu_tuple_cost = 0.03

# CPU index tuple cost
cpu_index_tuple_cost = 0.005

# CPU operator cost
cpu_operator_cost = 0.0025

# -----------------------------------------------------------------------------
#  LOGGING
# -----------------------------------------------------------------------------
# Log line prefix for better debugging
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '

# Log statement level (disable in production for performance)
# log_statement = 'ddl'  # Log only DDL statements
log_statement = 'none'   # No statement logging (production setting)

# Log slow queries (queries taking longer than 1 second)
log_min_duration_statement = 1000

# Log checkpoints
log_checkpoints = on

# Log connections and disconnections
log_connections = on
log_disconnections = on

# -----------------------------------------------------------------------------
#  AUTOVACUUM SETTINGS
# -----------------------------------------------------------------------------
# Enable autovacuum
autovacuum = on

# Number of autovacuum worker processes
autovacuum_max_workers = 3

# Time between autovacuum runs
autovacuum_naptime = 20s

# Vacuum threshold
autovacuum_vacuum_threshold = 50

# Vacuum scale factor
autovacuum_vacuum_scale_factor = 0.02

# Analyze threshold
autovacuum_analyze_threshold = 50

# Analyze scale factor
autovacuum_analyze_scale_factor = 0.01

# -----------------------------------------------------------------------------
#  CHECKPOINT SETTINGS
# -----------------------------------------------------------------------------
# Checkpoint segments (for WAL)
checkpoint_segments = 32

# Checkpoint completion target
checkpoint_completion_target = 0.9

# WAL buffers
wal_buffers = 16MB

# WAL writer delay
wal_writer_delay = 200ms

# -----------------------------------------------------------------------------
#  STATISTICS AND MONITORING
# -----------------------------------------------------------------------------
# Track activities
track_activities = on

# Track counts
track_counts = on

# Track IO timing
track_io_timing = on

# Update process title
update_process_title = on

# -----------------------------------------------------------------------------
#  CLIENT CONNECTION DEFAULTS
# -----------------------------------------------------------------------------
# Default transaction isolation
default_transaction_isolation = 'read committed'

# Default timezone
timezone = 'Asia/Jakarta'

# Client encoding
client_encoding = utf8

# -----------------------------------------------------------------------------
#  ERROR REPORTING AND LOGGING
# -----------------------------------------------------------------------------
# Log error verbosity
log_error_verbosity = default

# Log hostname
log_hostname = off

# Log timezone
log_timezone = 'Asia/Jakarta'

# -----------------------------------------------------------------------------
#  PERFORMANCE MONITORING
# -----------------------------------------------------------------------------
# Shared preload libraries for monitoring
shared_preload_libraries = 'pg_stat_statements'

# pg_stat_statements settings
pg_stat_statements.max = 10000
pg_stat_statements.track = all
pg_stat_statements.track_utility = off
pg_stat_statements.save = on

# -----------------------------------------------------------------------------
#  REPLICATION (disabled for single instance)
# -----------------------------------------------------------------------------
# Disable replication settings for single container
wal_level = replica
max_wal_senders = 0
hot_standby = off

# -----------------------------------------------------------------------------
#  ARCHIVING (disabled for development)
# -----------------------------------------------------------------------------
# Disable WAL archiving for development
archive_mode = off
# archive_command = 'cp %p /var/lib/postgresql/archive/%f'

# -----------------------------------------------------------------------------
#  OPTIMIZATION FOR CONTAINER ENVIRONMENT
# -----------------------------------------------------------------------------
# Disable fsync for development performance (DANGER: data loss possible)
# fsync = off

# Synchronous commit (set to off for development performance)
# synchronous_commit = off

# Full page writes
full_page_writes = on

# -----------------------------------------------------------------------------
#  RESOURCE LIMITS
# -----------------------------------------------------------------------------
# Maximum locks per transaction
max_locks_per_transaction = 64

# Maximum prepared transactions (disabled)
max_prepared_transactions = 0

# Maximum worker processes
max_worker_processes = 8

# Maximum parallel workers
max_parallel_workers = 8

# Maximum parallel workers per gather
max_parallel_workers_per_gather = 4

# -----------------------------------------------------------------------------
#  EXTENSIONS
# -----------------------------------------------------------------------------
# Allow extensions to be created
# (This is set in the init script, but can be set here too)
# Note: Extensions are loaded via init script for better control
